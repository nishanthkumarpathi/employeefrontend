name: Employee-Frontend-DevSecOps-Workflow

on:
  push:
    branches: [ development ]
  workflow_dispatch:

jobs:
  # sonarcloud-scan-job:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - name: Setup Node.js 18
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: '18'

  #     - name: Install dependencies
  #       run: npm install

  #     - name: SonarCloud Scan
  #       uses: sonarsource/sonarcloud-github-action@master
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #       with:
  #         args: >
  #           -Dsonar.organization=nishanthkumarpathi
  #           -Dsonar.projectKey=nishanthkumarpathi_employee-frontend
  #           -Dsonar.sources=.
  #           -Dsonar.host.url=https://sonarcloud.io


  # component-analysis:
  #   name: ComponentAnalysis-Node-NPMAudit
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout the Code
  #       uses: actions/checkout@v3

  #     - name: Setup Node.js 18
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: '18'

  #     - name: Install the Libraries or Node Modules
  #       run: npm install

  #     # - name: Perform Node.js Audit and Output to Json file
  #     #   run: npm audit --json >> node-audit-results.json
  #     #   continue-on-error: true

  #     - name: Perform Node.js Audit and Output to Json file
  #       run: |
  #         npm audit --json >> node-audit-results.json
  #         if [ $? -eq 0 ]; then
  #           echo "npm audit completed successfully"
  #         else
  #           echo "npm audit failed with exit code $?"
  #         fi
  #       continue-on-error: true

  #     - name: List the files available
  #       run: ls
      
  #     - name: Upload the Output as an artifact
  #       uses: actions/upload-artifact@v3.1.1
  #       with:
  #         name: NodeAudit Output
  #         path: node-audit-results.json
  #       if: always()

  # oast-frontend-retirejs:
  #   name: SAST-Frontend-Job-NodeJS-RetireJS
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout the Code
  #       uses: actions/checkout@v3

  #     - name: Setup Node.js 18
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: '18'
      
  #     - name: Install the Libraries or Node Modules
  #       run: npm install

  #     - name: Run RetireJS using docker image
  #       run: docker run --rm -v $(pwd):/src -w /src hysnsec/retire --outputformat json --outputpath retirejs-report.json --severity high
  #       continue-on-error: true

  #     - name: List the files available
  #       run: ls

  #     - name: Upload the Output as an artifact
  #       uses: actions/upload-artifact@v3.1.1
  #       with:
  #         name: RetireJS Output
  #         path: retirejs-report.json
  #       if: always()

  oast-snyk:
    name: SecretScanning-NodeJS-Synk
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the Code
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install the Libraries or Node Modules
        run: npm install

      - name: Download Snyk CLI and Mark it Executable
        run: |
          curl https://static.snyk.io/cli/latest/snyk-linux -o snyk
          chmod +x ./snyk
          mv ./snyk /usr/local/bin/ 

      - name: Run Snyk
        run: |
          snyk auth $SNYK_TOKEN
          snyk test --all-projects --org=2e302b9a-61b6-49a2-ad67-eb592b485463
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - uses: actions/upload-artifact@v3.1.1
        with:
          name: Snyk               
          path: snyk-results.json
        if: always()

  synk-scan-job:
    runs-on: ubuntu-latest
    # needs: sonarcloud-scan-job
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif
          command: test